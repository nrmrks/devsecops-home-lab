version: '3.8'

# Monitoring Stack for DevSecOps Lab
# Includes Prometheus for metrics collection and Grafana for visualization
# This is a placeholder configuration for future implementation

services:
  # Prometheus - Metrics collection and storage
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    
    ports:
      - "9090:9090"
    
    volumes:
      # Prometheus configuration file
      # Create this file with scrape configs for your services
      # - ./prometheus.yml:/etc/prometheus/prometheus.yml
      
      # Persist metrics data
      - prometheus_data:/prometheus
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    
    networks:
      - monitoring
    
    # healthcheck:
    #   test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

  # Grafana - Metrics visualization and dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    
    ports:
      - "3001:3000"  # Using 3001 to avoid conflict with app on 3000
    
    volumes:
      # Persist Grafana data (dashboards, users, etc.)
      - grafana_data:/var/lib/grafana
      
      # Optional: Pre-configure datasources and dashboards
      # - ./grafana/provisioning:/etc/grafana/provisioning
    
    environment:
      # Admin credentials (change in production!)
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      
      # Anonymous access for demo (disable in production)
      # - GF_AUTH_ANONYMOUS_ENABLED=true
      # - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      
      # Disable user signup
      - GF_USERS_ALLOW_SIGN_UP=false
    
    networks:
      - monitoring
    
    depends_on:
      - prometheus
    
    # healthcheck:
    #   test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

  # Node Exporter - Collect host metrics (optional)
  # node-exporter:
  #   image: prom/node-exporter:latest
  #   container_name: node-exporter
  #   restart: unless-stopped
  #   
  #   ports:
  #     - "9100:9100"
  #   
  #   volumes:
  #     - /proc:/host/proc:ro
  #     - /sys:/host/sys:ro
  #     - /:/rootfs:ro
  #   
  #   command:
  #     - '--path.procfs=/host/proc'
  #     - '--path.sysfs=/host/sys'
  #     - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
  #   
  #   networks:
  #     - monitoring

  # cAdvisor - Container metrics (optional)
  # cadvisor:
  #   image: gcr.io/cadvisor/cadvisor:latest
  #   container_name: cadvisor
  #   restart: unless-stopped
  #   
  #   ports:
  #     - "8081:8080"
  #   
  #   volumes:
  #     - /:/rootfs:ro
  #     - /var/run:/var/run:ro
  #     - /sys:/sys:ro
  #     - /var/lib/docker/:/var/lib/docker:ro
  #   
  #   networks:
  #     - monitoring

volumes:
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  monitoring:
    driver: bridge

# ================================================================================
# SETUP INSTRUCTIONS
# ================================================================================
#
# 1. Create Prometheus configuration file:
#    Create a file at docker/monitoring/prometheus.yml with:
#
#    global:
#      scrape_interval: 15s
#      evaluation_interval: 15s
#    
#    scrape_configs:
#      - job_name: 'prometheus'
#        static_configs:
#          - targets: ['localhost:9090']
#      
#      - job_name: 'nodejs-app'
#        static_configs:
#          - targets: ['host.docker.internal:3000']
#      
#      - job_name: 'jenkins'
#        metrics_path: '/prometheus'
#        static_configs:
#          - targets: ['host.docker.internal:8080']
#
# 2. Uncomment the volume mount for prometheus.yml in the prometheus service above
#
# 3. Start the monitoring stack:
#    docker-compose up -d
#
# 4. Access the services:
#    - Prometheus: http://localhost:9090
#    - Grafana: http://localhost:3001 (admin/admin)
#
# 5. Configure Grafana:
#    - Add Prometheus as data source: http://prometheus:9090
#    - Import dashboards or create custom ones
#    - Recommended dashboards:
#      * Docker Dashboard: 193
#      * Node Exporter: 1860
#      * Jenkins: 9964
#
# 6. Instrument your application:
#    - Add Prometheus client library to Node.js app
#    - Expose metrics endpoint (e.g., /metrics)
#    - Update Prometheus scrape config to collect metrics
#
# ================================================================================
# INTEGRATION WITH JENKINS
# ================================================================================
#
# To monitor Jenkins builds and job metrics:
#
# 1. Install Jenkins Prometheus Plugin:
#    - In Jenkins: Manage Jenkins â†’ Manage Plugins
#    - Search for "Prometheus metrics plugin"
#    - Install and restart Jenkins
#
# 2. Configure Jenkins metrics endpoint:
#    - Metrics will be available at: http://localhost:8080/prometheus
#
# 3. Add Jenkins to Prometheus scrape config (see prometheus.yml above)
#
# 4. Create Grafana dashboards for:
#    - Build success/failure rates
#    - Build duration trends
#    - Queue length
#    - Executor utilization
#
# ================================================================================
# INTEGRATION WITH NODE.JS APPLICATION
# ================================================================================
#
# To add metrics to the Node.js app:
#
# 1. Install Prometheus client:
#    npm install prom-client
#
# 2. Add to app.js:
#    const promClient = require('prom-client');
#    const register = new promClient.Registry();
#    promClient.collectDefaultMetrics({ register });
#    
#    app.get('/metrics', async (req, res) => {
#      res.set('Content-Type', register.contentType);
#      res.end(await register.metrics());
#    });
#
# 3. Update Prometheus config to scrape /metrics endpoint
#
# ================================================================================
# USEFUL PROMETHEUS QUERIES
# ================================================================================
#
# Request rate:
#   rate(http_requests_total[5m])
#
# CPU usage:
#   rate(process_cpu_seconds_total[1m])
#
# Memory usage:
#   process_resident_memory_bytes
#
# Jenkins build duration:
#   jenkins_builds_duration_milliseconds_summary
#
# ================================================================================
